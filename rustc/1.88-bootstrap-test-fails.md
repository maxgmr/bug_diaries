## The Problem

A wide range of bootstrap tests are now failing. A great deal of the tests (but not all of them) are new.

## Original Test Failures

These are not all test failures in the original build log.

First, there are four tests (`ci_rustc_if_unchanged_*`) which require an upstream Git repository. This is not applicable for our toolchain, so these tests have already been disabled.

Second, `tests/run-make/linker-warning` has failed in previous versions and is not newly-introduced in 1.88. It should be considered separately from the tests listed here.

#### assertion failed: compiler_builtins_root.exists()

Tests failing for this reason:

- `alias_and_path_for_library`
- `build_cross_compile`
- `build_default`
- `build_stage_0`
- `doc_default`
- `build_all`
- `build_with_empty_host`
- `dist_baseline`
- `dist_only_cross_host`
- `dist_with_empty_host`
- `dist_with_hosts`
- `dist_with_same_targets_and_hosts`
- `dist_with_targets`
- `dist_with_targets_and_hosts`
- `doc_ci`
- `test_docs`
- `test_with_no_doc_stage0`
- `test_exclude`
- `test_get_tool_rustc_compiler`
- `test_test_compiler`
- `test_valid`

Example:

```
thread 'core::builder::tests::alias_and_path_for_library' panicked at src/bootstrap/src/core/build_steps/compile.rs:584:9:
assertion failed: compiler_builtins_root.exists()
stack backtrace:
   0: __rustc::rust_begin_unwind
             at /build/rustc-1.87-u8IF76/rustc-1.87-1.87.0+dfsg0ubuntu1/library/std/src/panicking.rs:697:5
   1: core::panicking::panic_fmt
             at /build/rustc-1.87-u8IF76/rustc-1.87-1.87.0+dfsg0ubuntu1/library/core/src/panicking.rs:75:14
   2: core::panicking::panic
             at /build/rustc-1.87-u8IF76/rustc-1.87-1.87.0+dfsg0ubuntu1/library/core/src/panicking.rs:145:5
   3: bootstrap::core::build_steps::compile::std_cargo
             at ./src/core/build_steps/compile.rs:584:9
   4: <bootstrap::core::build_steps::compile::Std as bootstrap::core::builder::Step>::run
             at ./src/core/build_steps/compile.rs:272:13
   5: <bootstrap::core::builder::Builder>::ensure::<bootstrap::core::build_steps::compile::Std>
             at ./src/core/builder/mod.rs:1512:23
   6: <bootstrap::core::build_steps::compile::Rustc as bootstrap::core::builder::Step>::run
             at ./src/core/build_steps/compile.rs:1046:9
   7: <bootstrap::core::builder::Builder>::ensure::<bootstrap::core::build_steps::compile::Rustc>
             at ./src/core/builder/mod.rs:1512:23
   8: <bootstrap::core::build_steps::compile::Assemble as bootstrap::core::builder::Step>::run
             at ./src/core/build_steps/compile.rs:2091:28
   9: <bootstrap::core::builder::Builder>::ensure::<bootstrap::core::build_steps::compile::Assemble>
             at ./src/core/builder/mod.rs:1512:23
  10: <bootstrap::core::builder::Builder>::compiler
             at ./src/core/builder/mod.rs:1229:9
  11: <bootstrap::core::build_steps::compile::Std as bootstrap::core::builder::Step>::make_run
             at ./src/core/build_steps/compile.rs:121:23
  12: <bootstrap::core::builder::StepDescription>::maybe_run
             at ./src/core/builder/mod.rs:439:13
  13: <bootstrap::core::builder::StepDescription>::run
             at ./src/core/builder/mod.rs:569:17
  14: <bootstrap::core::builder::Builder>::run_step_descriptions
             at ./src/core/builder/mod.rs:1202:9
  15: bootstrap::core::builder::tests::run_build
             at ./src/core/builder/tests.rs:63:5
  16: bootstrap::core::builder::tests::alias_and_path_for_library
             at ./src/core/builder/tests.rs:222:21
  17: bootstrap::core::builder::tests::alias_and_path_for_library::{closure#0}
             at ./src/core/builder/tests.rs:221:32
  18: <bootstrap::core::builder::tests::alias_and_path_for_library::{closure#0} as core::ops::function::FnOnce<()>>::call_once
             at /build/rustc-1.87-u8IF76/rustc-1.87-1.87.0+dfsg0ubuntu1/library/core/src/ops/function.rs:250:5
  19: core::ops::function::FnOnce::call_once
             at /build/rustc-1.87-u8IF76/rustc-1.87-1.87.0+dfsg0ubuntu1/library/core/src/ops/function.rs:250:5
```

#### Couldn't find required command: ninja

Tests failing for this reason:

- `dist_all_cross`

Example:

```
Building LLVM for i686-unknown-haiku

Couldn't find required command: ninja (or ninja-build)

You should install ninja as described at
<https://github.com/ninja-build/ninja/wiki/Pre-built-Ninja-packages>,
or set `ninja = false` in the `[llvm]` section of `bootstrap.toml`.
Alternatively, set `download-ci-llvm = true` in that `[llvm]` section
to download LLVM rather than building it.
```

#### x.py completions were changed

Tests failing for this reason:

- `test_exclude_kind`
- `test_test_coverage`

Example:

```
x.py completions were changed; run `x.py run generate-completions` to update them

thread 'core::builder::tests::test_test_coverage' panicked at src/build_helper/src/util.rs:22:9:
status code: 1
stack backtrace:
   0: __rustc::rust_begin_unwind
             at /build/rustc-1.87-u8IF76/rustc-1.87-1.87.0+dfsg0ubuntu1/library/std/src/panicking.rs:697:5
   1: core::panicking::panic_fmt
             at /build/rustc-1.87-u8IF76/rustc-1.87-1.87.0+dfsg0ubuntu1/library/core/src/panicking.rs:75:14
   2: build_helper::util::detail_exit
             at /<<PKGBUILDDIR>>/src/build_helper/src/util.rs:22:9
   3: <bootstrap::core::build_steps::test::Tidy as bootstrap::core::builder::Step>::run
             at ./src/core/build_steps/test.rs:1148:13
   4: <bootstrap::core::builder::Builder>::ensure::<bootstrap::core::build_steps::test::Tidy>
             at ./src/core/builder/mod.rs:1512:23
   5: <bootstrap::core::build_steps::test::Tidy as bootstrap::core::builder::Step>::make_run
             at ./src/core/build_steps/test.rs:1158:9
   6: <bootstrap::core::builder::StepDescription>::maybe_run
             at ./src/core/builder/mod.rs:439:13
   7: <bootstrap::core::builder::StepDescription>::run
             at ./src/core/builder/mod.rs:489:21
   8: <bootstrap::core::builder::Builder>::run_step_descriptions
             at ./src/core/builder/mod.rs:1202:9
   9: bootstrap::core::builder::tests::run_build
             at ./src/core/builder/tests.rs:63:5
  10: bootstrap::core::builder::tests::test_test_coverage
             at ./src/core/builder/tests.rs:1056:25
  11: bootstrap::core::builder::tests::test_test_coverage::{closure#0}
             at ./src/core/builder/tests.rs:1032:24
  12: <bootstrap::core::builder::tests::test_test_coverage::{closure#0} as core::ops::function::FnOnce<()>>::call_once
             at /build/rustc-1.87-u8IF76/rustc-1.87-1.87.0+dfsg0ubuntu1/library/core/src/ops/function.rs:250:5
  13: core::ops::function::FnOnce::call_once
             at /build/rustc-1.87-u8IF76/rustc-1.87-1.87.0+dfsg0ubuntu1/library/core/src/ops/function.rs:250:5
```

#### 'if-unchanged' is only compatible with Git managed sources

Tests failing for this reason:

- `test_prebuilt_llvm_config_path_resolution`
- `test_ci_flag`

Example:

```
ERROR: 'if-unchanged' is only compatible with Git managed sources.

thread 'core::builder::tests::test_prebuilt_llvm_config_path_resolution' panicked at src/build_helper/src/util.rs:22:9:
status code: 1
stack backtrace:
   0: __rustc::rust_begin_unwind
             at /build/rustc-1.87-u8IF76/rustc-1.87-1.87.0+dfsg0ubuntu1/library/std/src/panicking.rs:697:5
   1: core::panicking::panic_fmt
             at /build/rustc-1.87-u8IF76/rustc-1.87-1.87.0+dfsg0ubuntu1/library/core/src/panicking.rs:75:14
   2: build_helper::util::detail_exit
             at /<<PKGBUILDDIR>>/src/build_helper/src/util.rs:22:9
   3: <bootstrap::core::config::config::Config>::parse_download_ci_llvm::{closure#0}
             at ./src/core/config/config.rs:3264:17
   4: <bootstrap::core::config::config::Config>::parse_download_ci_llvm
             at ./src/core/config/config.rs:3296:63
   5: <bootstrap::core::config::config::Config>::parse_inner::<bootstrap::core::builder::tests::test_prebuilt_llvm_config_path_resolution::configure::{closure#0}>
             at ./src/core/config/config.rs:2272:17
   6: bootstrap::core::builder::tests::test_prebuilt_llvm_config_path_resolution::configure
             at ./src/core/builder/tests.rs:1067:9
   7: bootstrap::core::builder::tests::test_prebuilt_llvm_config_path_resolution
             at ./src/core/builder/tests.rs:1151:18
   8: bootstrap::core::builder::tests::test_prebuilt_llvm_config_path_resolution::{closure#0}
             at ./src/core/builder/tests.rs:1065:47
   9: <bootstrap::core::builder::tests::test_prebuilt_llvm_config_path_resolution::{closure#0} as core::ops::function::FnOnce<()>>::call_once
             at /build/rustc-1.87-u8IF76/rustc-1.87-1.87.0+dfsg0ubuntu1/library/core/src/ops/function.rs:250:5
  10: core::ops::function::FnOnce::call_once
             at /build/rustc-1.87-u8IF76/rustc-1.87-1.87.0+dfsg0ubuntu1/library/core/src/ops/function.rs:250:5
```

#### triagebot.toml doesn't exist

Tests failing for this reason:

- `check_rustc_if_unchanged_paths`

Example:

```
thread 'core::config::tests::check_rustc_if_unchanged_paths' panicked at src/bootstrap/src/core/config/tests.rs:474:9:
triagebot.toml doesn't exist.
stack backtrace:
   0: __rustc::rust_begin_unwind
             at /build/rustc-1.87-u8IF76/rustc-1.87-1.87.0+dfsg0ubuntu1/library/std/src/panicking.rs:697:5
   1: core::panicking::panic_fmt
             at /build/rustc-1.87-u8IF76/rustc-1.87-1.87.0+dfsg0ubuntu1/library/core/src/panicking.rs:75:14
   2: bootstrap::core::config::tests::check_rustc_if_unchanged_paths
             at ./src/core/config/tests.rs:474:9
   3: bootstrap::core::config::tests::check_rustc_if_unchanged_paths::{closure#0}
             at ./src/core/config/tests.rs:464:36
   4: <bootstrap::core::config::tests::check_rustc_if_unchanged_paths::{closure#0} as core::ops::function::FnOnce<()>>::call_once
             at /build/rustc-1.87-u8IF76/rustc-1.87-1.87.0+dfsg0ubuntu1/library/core/src/ops/function.rs:250:5
   5: core::ops::function::FnOnce::call_once
             at /build/rustc-1.87-u8IF76/rustc-1.87-1.87.0+dfsg0ubuntu1/library/core/src/ops/function.rs:250:5
```

#### None != Some("src/tools/cargo")

Tests failing for this reason:

- `test_submodule_path_of`

Example:

```
thread 'utils::helpers::tests::test_submodule_path_of' panicked at src/bootstrap/src/utils/helpers/tests.rs:112:5:
assertion `left == right` failed
  left: None
 right: Some("src/tools/cargo")
stack backtrace:
   0: __rustc::rust_begin_unwind
             at /build/rustc-1.87-u8IF76/rustc-1.87-1.87.0+dfsg0ubuntu1/library/std/src/panicking.rs:697:5
   1: core::panicking::panic_fmt
             at /build/rustc-1.87-u8IF76/rustc-1.87-1.87.0+dfsg0ubuntu1/library/core/src/panicking.rs:75:14
   2: core::panicking::assert_failed_inner
             at /build/rustc-1.87-u8IF76/rustc-1.87-1.87.0+dfsg0ubuntu1/library/core/src/panicking.rs:425:17
   3: core::panicking::assert_failed::<core::option::Option<alloc::string::String>, core::option::Option<alloc::string::String>>
             at /build/rustc-1.87-u8IF76/rustc-1.87-1.87.0+dfsg0ubuntu1/library/core/src/panicking.rs:380:5
   4: bootstrap::utils::helpers::tests::test_submodule_path_of
             at ./src/utils/helpers/tests.rs:112:5
   5: bootstrap::utils::helpers::tests::test_submodule_path_of::{closure#0}
             at ./src/utils/helpers/tests.rs:104:28
   6: <bootstrap::utils::helpers::tests::test_submodule_path_of::{closure#0} as core::ops::function::FnOnce<()>>::call_once
             at /build/rustc-1.87-u8IF76/rustc-1.87-1.87.0+dfsg0ubuntu1/library/core/src/ops/function.rs:250:5
   7: core::ops::function::FnOnce::call_once
             at /build/rustc-1.87-u8IF76/rustc-1.87-1.87.0+dfsg0ubuntu1/library/core/src/ops/function.rs:250:5
```

## Fix Attempt 1: Picking individual fields from `d/bootstrap.toml`

#### Diagnosis

These test failures are likely related to bootstrap configuration issues. `d/bootstrap.toml` is responsible for configuring bootstrapping, but tests don't use this file:

(`src/boostrap/src/core/config/config.rs`, line 1430)

```rust
    pub(crate) fn get_toml(file: &Path) -> Result<TomlConfig, toml::de::Error> {
        #[cfg(test)]
        return Ok(TomlConfig::default());

        #[cfg(not(test))]
        Self::get_toml_inner(file)
    }
```

This isn't normally an issue, but our packaged version is special. We don't have access to a vendored LLVM, we can't download rustc for testing purposes, we aren't using an upstream Git repo, etc.

Therefore, these tests are likely failing because they're assuming we're _able_ to use the default configuration, which isn't true in our special case. Some default configuration settings simply don't work for us. (See `./bootstrap.example.toml` for documentation on all the bootstrap configuration options along with their defaults.)

#### Attempted solution

This patch changes things by _still_ reading `d/bootstrap.toml`, even when in test mode:

```diff
--- a/src/bootstrap/src/core/config/config.rs
+++ b/src/bootstrap/src/core/config/config.rs
@@ -1428,10 +1428,6 @@
     }

     pub(crate) fn get_toml(file: &Path) -> Result<TomlConfig, toml::de::Error> {
-        #[cfg(test)]
-        return Ok(TomlConfig::default());
-
-        #[cfg(not(test))]
         Self::get_toml_inner(file)
     }
```

The following content is contained within an `if cfg!(test) { ... }` block. We want to keep things as similar to their "intended" defaults as possible. After getting the _actual_ bootstrap config, we create `TomlConfig::default()` and assign it certain configuration values which are non-negotiable from our toolchain's perspective:

```diff
--- a/src/bootstrap/src/core/config/config.rs
+++ b/src/bootstrap/src/core/config/config.rs
@@ -1629,6 +1625,28 @@
         };

         if cfg!(test) {
+            // We just got the custom bootstrap.toml. However, in a testing environment, we just
+            // want to cherry-pick the settings that matter.
+            let mut test_toml = TomlConfig::default();
+
+            let mut test_build = Build::default();
+            if let Some(build) = toml.build {
+                test_build.submodules = build.submodules;
+                test_build.vendor = build.vendor;
+                test_build.locked_deps = build.locked_deps;
+                test_build.tools = build.tools;
+                test_build.build = build.build;
+                test_build.host = build.host;
+                test_build.target = build.target;
+                test_build.optimized_compiler_builtins = build.optimized_compiler_builtins;
+            }
+            test_toml.build = Some(test_build);
+
+            test_toml.llvm = toml.llvm;
+            test_toml.rust = toml.rust;
+
+            toml = test_toml;
+
             // When configuring bootstrap for tests, make sure to set the rustc and Cargo to the
             // same ones used to call the tests (if custom ones are not defined in the toml). If we
             // don't do that, bootstrap will use its own detection logic to find a suitable rustc
```

For instance, the list of tools (`build.tools`) is non-negotiable — attempting to build all tools by default will naturally fail because the tools we don't need have been stripped from the orig tarball.

This was just a quick test, so it's not as granular as it could be — the `llvm` and `rust` configurations have just been taken verbatim. The `llvm` config does things like preventing tests from attempting to use the vendored `compiler-rt` (which doesn't exist for us). The `rust` configuration does things like preventing tests from attempting to download `rustc`.

## Test Failures After Fix 1

Happily, the only tests which still fail were already failing. They're now just failing for different reasons.

The most common failure, `compiler_builtins_root.exists()`, was fixed by setting `build.optimized_compiler_builtins` to the value in `d/bootstrap.toml` (i.e., disabling it). The failure was caused because the default assumes vendored LLVM and tries to use the vendored `compiler-rt`, which naturally doesn't exist for our toolchain.

#### compile::Std builds stage 2

Tests failing for this reason:

- `alias_and_path_for_library`
- `build_default`

Example:

```
thread 'core::builder::tests::defaults::build_default' panicked at src/bootstrap/src/core/builder/tests.rs:333:9:
assertion failed: `(left == right)`

Diff < left / right > :
 [
     Std {
         target: i686-unknown-haiku,
         compiler: Compiler {
             stage: 0,
             host: i686-unknown-haiku,
             forced_compiler: false,
         },
         crates: [],
         force_recompile: false,
         extra_rust_args: [],
         is_for_mir_opt_tests: false,
     },
     Std {
         target: i686-unknown-haiku,
         compiler: Compiler {
             stage: 1,
             host: i686-unknown-haiku,
             forced_compiler: false,
         },
         crates: [],
         force_recompile: false,
         extra_rust_args: [],
         is_for_mir_opt_tests: false,
     },
<    Std {
<        target: i686-unknown-haiku,
<        compiler: Compiler {
<            stage: 2,
<            host: i686-unknown-haiku,
<            forced_compiler: false,
<        },
<        crates: [],
<        force_recompile: false,
<        extra_rust_args: [],
<        is_for_mir_opt_tests: false,
<    },
 ]


stack backtrace:
   0: __rustc::rust_begin_unwind
             at /build/rustc-1.87-u8IF76/rustc-1.87-1.87.0+dfsg0ubuntu1/library/std/src/panicking.rs:697:5
   1: core::panicking::panic_fmt
             at /build/rustc-1.87-u8IF76/rustc-1.87-1.87.0+dfsg0ubuntu1/library/core/src/panicking.rs:75:14
   2: bootstrap::core::builder::tests::defaults::build_default
             at ./src/core/builder/tests.rs:333:9
   3: bootstrap::core::builder::tests::defaults::build_default::{closure#0}
             at ./src/core/builder/tests.rs:329:23
   4: <bootstrap::core::builder::tests::defaults::build_default::{closure#0} as core::ops::function::FnOnce<()>>::call_once
             at /build/rustc-1.87-u8IF76/rustc-1.87-1.87.0+dfsg0ubuntu1/library/core/src/ops/function.rs:250:5
   5: core::ops::function::FnOnce::call_once
             at /build/rustc-1.87-u8IF76/rustc-1.87-1.87.0+dfsg0ubuntu1/library/core/src/ops/function.rs:250:5
```

#### compile::Rustc builds something instead of nothing

Tests failing for this reason:

- `build_stage_0`

Example:

```
thread 'core::builder::tests::defaults::build_stage_0' panicked at src/bootstrap/src/core/builder/tests.rs:371:9:
assertion failed: cache.all::<compile::Rustc>().is_empty()
stack backtrace:
   0: __rustc::rust_begin_unwind
             at /build/rustc-1.87-u8IF76/rustc-1.87-1.87.0+dfsg0ubuntu1/library/std/src/panicking.rs:697:5
   1: core::panicking::panic_fmt
             at /build/rustc-1.87-u8IF76/rustc-1.87-1.87.0+dfsg0ubuntu1/library/core/src/panicking.rs:75:14
   2: core::panicking::panic
             at /build/rustc-1.87-u8IF76/rustc-1.87-1.87.0+dfsg0ubuntu1/library/core/src/panicking.rs:145:5
   3: bootstrap::core::builder::tests::defaults::build_stage_0
             at ./src/core/builder/tests.rs:371:9
   4: bootstrap::core::builder::tests::defaults::build_stage_0::{closure#0}
             at ./src/core/builder/tests.rs:355:23
   5: <bootstrap::core::builder::tests::defaults::build_stage_0::{closure#0} as core::ops::function::FnOnce<()>>::call_once
             at /build/rustc-1.87-u8IF76/rustc-1.87-1.87.0+dfsg0ubuntu1/library/core/src/ops/function.rs:250:5
   6: core::ops::function::FnOnce::call_once
             at /build/rustc-1.87-u8IF76/rustc-1.87-1.87.0+dfsg0ubuntu1/library/core/src/ops/function.rs:250:5
```

#### Wrong Compiler stage and forced_compiler

Tests failing for this reason:

- `doc_default`

Example:

```
thread 'core::builder::tests::defaults::doc_default' panicked at src/bootstrap/src/core/builder/tests.rs:434:9:
assertion failed: `(left == right)`

Diff < left / right > :
 [
     ErrorIndex {
         compiler: Compiler {
<            stage: 1,
>            stage: 0,
             host: i686-unknown-haiku,
<            forced_compiler: true,
>            forced_compiler: false,
         },
     },
 ]


stack backtrace:
   0: __rustc::rust_begin_unwind
             at /build/rustc-1.87-u8IF76/rustc-1.87-1.87.0+dfsg0ubuntu1/library/std/src/panicking.rs:697:5
   1: core::panicking::panic_fmt
             at /build/rustc-1.87-u8IF76/rustc-1.87-1.87.0+dfsg0ubuntu1/library/core/src/panicking.rs:75:14
   2: bootstrap::core::builder::tests::defaults::doc_default
             at ./src/core/builder/tests.rs:434:9
   3: bootstrap::core::builder::tests::defaults::doc_default::{closure#0}
             at ./src/core/builder/tests.rs:424:21
   4: <bootstrap::core::builder::tests::defaults::doc_default::{closure#0} as core::ops::function::FnOnce<()>>::call_once
             at /build/rustc-1.87-u8IF76/rustc-1.87-1.87.0+dfsg0ubuntu1/library/core/src/ops/function.rs:250:5
   5: core::ops::function::FnOnce::call_once
             at /build/rustc-1.87-u8IF76/rustc-1.87-1.87.0+dfsg0ubuntu1/library/core/src/ops/function.rs:250:5
```

## Fix Attempt 2

#### Test failures analysis

The obvious common thread here is that this config is building too many stages. The `doc_default` error message appears to be the most helpful here. Let's see what stage the config is, and whether or not it's being set manually (`src/bootstrap/src/`):

```diff
     #[test]
     fn doc_default() {
         let mut config = configure("doc", &[TEST_TRIPLE_1], &[TEST_TRIPLE_1]);
         config.compiler_docs = true;
         config.cmd = Subcommand::Doc { open: false, json: false };
+        println!("config.stage: {} (explicit cli = {}, explicit config = {})", config.stage, config.explicit_stage_from_cli, config.explicit_stage_from_config);
         let mut cache = run_build(&[], config);
         let a = TargetSelection::from_user(TEST_TRIPLE_1);
```

Here's the result:

```
config.stage: 2 (explicit cli = false, explicit config = true)
```

While it's good that `config.explicit_stage_from_config` matches what's expected, there's _two_ weird things regarding `config.stage`:

1. It doesn't match the expected value of `compiler.stage`.
2. It doesn't match the _actual_ value of `compiler.stage`!

Let's see if it's being caused by the patch. We'll quickly comment out our patch and try again:

```
config.stage: 2 (explicit cli = false, explicit config = true)
```

It's the same result. This means that this is a separate problem.
