## The Problem

A wide range of bootstrap tests are now failing. A great deal of the tests (but not all of them) are new.

## Original Test Failures

These are not all test failures in the original build log.

First, there are four tests (`ci_rustc_if_unchanged_*`) which require an upstream Git repository. This is not applicable for our toolchain, so these tests have already been disabled.

Second, `tests/run-make/linker-warning` has failed in previous versions and is not newly-introduced in 1.88. It should be considered separately from the tests listed here.

#### assertion failed: compiler_builtins_root.exists()

Tests failing for this reason:

- `alias_and_path_for_library`
- `build_cross_compile`
- `build_default`
- `build_stage_0`
- `doc_default`
- `build_all`
- `build_with_empty_host`
- `dist_baseline`
- `dist_only_cross_host`
- `dist_with_empty_host`
- `dist_with_hosts`
- `dist_with_same_targets_and_hosts`
- `dist_with_targets`
- `dist_with_targets_and_hosts`
- `doc_ci`
- `test_docs`
- `test_with_no_doc_stage0`
- `test_exclude`
- `test_get_tool_rustc_compiler`
- `test_test_compiler`
- `test_valid`

Example:

```
thread 'core::builder::tests::alias_and_path_for_library' panicked at src/bootstrap/src/core/build_steps/compile.rs:584:9:
assertion failed: compiler_builtins_root.exists()
stack backtrace:
   0: __rustc::rust_begin_unwind
             at /build/rustc-1.87-u8IF76/rustc-1.87-1.87.0+dfsg0ubuntu1/library/std/src/panicking.rs:697:5
   1: core::panicking::panic_fmt
             at /build/rustc-1.87-u8IF76/rustc-1.87-1.87.0+dfsg0ubuntu1/library/core/src/panicking.rs:75:14
   2: core::panicking::panic
             at /build/rustc-1.87-u8IF76/rustc-1.87-1.87.0+dfsg0ubuntu1/library/core/src/panicking.rs:145:5
   3: bootstrap::core::build_steps::compile::std_cargo
             at ./src/core/build_steps/compile.rs:584:9
   4: <bootstrap::core::build_steps::compile::Std as bootstrap::core::builder::Step>::run
             at ./src/core/build_steps/compile.rs:272:13
   5: <bootstrap::core::builder::Builder>::ensure::<bootstrap::core::build_steps::compile::Std>
             at ./src/core/builder/mod.rs:1512:23
   6: <bootstrap::core::build_steps::compile::Rustc as bootstrap::core::builder::Step>::run
             at ./src/core/build_steps/compile.rs:1046:9
   7: <bootstrap::core::builder::Builder>::ensure::<bootstrap::core::build_steps::compile::Rustc>
             at ./src/core/builder/mod.rs:1512:23
   8: <bootstrap::core::build_steps::compile::Assemble as bootstrap::core::builder::Step>::run
             at ./src/core/build_steps/compile.rs:2091:28
   9: <bootstrap::core::builder::Builder>::ensure::<bootstrap::core::build_steps::compile::Assemble>
             at ./src/core/builder/mod.rs:1512:23
  10: <bootstrap::core::builder::Builder>::compiler
             at ./src/core/builder/mod.rs:1229:9
  11: <bootstrap::core::build_steps::compile::Std as bootstrap::core::builder::Step>::make_run
             at ./src/core/build_steps/compile.rs:121:23
  12: <bootstrap::core::builder::StepDescription>::maybe_run
             at ./src/core/builder/mod.rs:439:13
  13: <bootstrap::core::builder::StepDescription>::run
             at ./src/core/builder/mod.rs:569:17
  14: <bootstrap::core::builder::Builder>::run_step_descriptions
             at ./src/core/builder/mod.rs:1202:9
  15: bootstrap::core::builder::tests::run_build
             at ./src/core/builder/tests.rs:63:5
  16: bootstrap::core::builder::tests::alias_and_path_for_library
             at ./src/core/builder/tests.rs:222:21
  17: bootstrap::core::builder::tests::alias_and_path_for_library::{closure#0}
             at ./src/core/builder/tests.rs:221:32
  18: <bootstrap::core::builder::tests::alias_and_path_for_library::{closure#0} as core::ops::function::FnOnce<()>>::call_once
             at /build/rustc-1.87-u8IF76/rustc-1.87-1.87.0+dfsg0ubuntu1/library/core/src/ops/function.rs:250:5
  19: core::ops::function::FnOnce::call_once
             at /build/rustc-1.87-u8IF76/rustc-1.87-1.87.0+dfsg0ubuntu1/library/core/src/ops/function.rs:250:5
```

#### Couldn't find required command: ninja

Tests failing for this reason:

- `dist_all_cross`

Example:

```
Building LLVM for i686-unknown-haiku

Couldn't find required command: ninja (or ninja-build)

You should install ninja as described at
<https://github.com/ninja-build/ninja/wiki/Pre-built-Ninja-packages>,
or set `ninja = false` in the `[llvm]` section of `bootstrap.toml`.
Alternatively, set `download-ci-llvm = true` in that `[llvm]` section
to download LLVM rather than building it.
```

#### x.py completions were changed

Tests failing for this reason:

- `test_exclude_kind`
- `test_test_coverage`

Example:

```
x.py completions were changed; run `x.py run generate-completions` to update them

thread 'core::builder::tests::test_test_coverage' panicked at src/build_helper/src/util.rs:22:9:
status code: 1
stack backtrace:
   0: __rustc::rust_begin_unwind
             at /build/rustc-1.87-u8IF76/rustc-1.87-1.87.0+dfsg0ubuntu1/library/std/src/panicking.rs:697:5
   1: core::panicking::panic_fmt
             at /build/rustc-1.87-u8IF76/rustc-1.87-1.87.0+dfsg0ubuntu1/library/core/src/panicking.rs:75:14
   2: build_helper::util::detail_exit
             at /<<PKGBUILDDIR>>/src/build_helper/src/util.rs:22:9
   3: <bootstrap::core::build_steps::test::Tidy as bootstrap::core::builder::Step>::run
             at ./src/core/build_steps/test.rs:1148:13
   4: <bootstrap::core::builder::Builder>::ensure::<bootstrap::core::build_steps::test::Tidy>
             at ./src/core/builder/mod.rs:1512:23
   5: <bootstrap::core::build_steps::test::Tidy as bootstrap::core::builder::Step>::make_run
             at ./src/core/build_steps/test.rs:1158:9
   6: <bootstrap::core::builder::StepDescription>::maybe_run
             at ./src/core/builder/mod.rs:439:13
   7: <bootstrap::core::builder::StepDescription>::run
             at ./src/core/builder/mod.rs:489:21
   8: <bootstrap::core::builder::Builder>::run_step_descriptions
             at ./src/core/builder/mod.rs:1202:9
   9: bootstrap::core::builder::tests::run_build
             at ./src/core/builder/tests.rs:63:5
  10: bootstrap::core::builder::tests::test_test_coverage
             at ./src/core/builder/tests.rs:1056:25
  11: bootstrap::core::builder::tests::test_test_coverage::{closure#0}
             at ./src/core/builder/tests.rs:1032:24
  12: <bootstrap::core::builder::tests::test_test_coverage::{closure#0} as core::ops::function::FnOnce<()>>::call_once
             at /build/rustc-1.87-u8IF76/rustc-1.87-1.87.0+dfsg0ubuntu1/library/core/src/ops/function.rs:250:5
  13: core::ops::function::FnOnce::call_once
             at /build/rustc-1.87-u8IF76/rustc-1.87-1.87.0+dfsg0ubuntu1/library/core/src/ops/function.rs:250:5
```

#### 'if-unchanged' is only compatible with Git managed sources

Tests failing for this reason:

- `test_prebuilt_llvm_config_path_resolution`
- `test_ci_flag`

Example:

```
ERROR: 'if-unchanged' is only compatible with Git managed sources.

thread 'core::builder::tests::test_prebuilt_llvm_config_path_resolution' panicked at src/build_helper/src/util.rs:22:9:
status code: 1
stack backtrace:
   0: __rustc::rust_begin_unwind
             at /build/rustc-1.87-u8IF76/rustc-1.87-1.87.0+dfsg0ubuntu1/library/std/src/panicking.rs:697:5
   1: core::panicking::panic_fmt
             at /build/rustc-1.87-u8IF76/rustc-1.87-1.87.0+dfsg0ubuntu1/library/core/src/panicking.rs:75:14
   2: build_helper::util::detail_exit
             at /<<PKGBUILDDIR>>/src/build_helper/src/util.rs:22:9
   3: <bootstrap::core::config::config::Config>::parse_download_ci_llvm::{closure#0}
             at ./src/core/config/config.rs:3264:17
   4: <bootstrap::core::config::config::Config>::parse_download_ci_llvm
             at ./src/core/config/config.rs:3296:63
   5: <bootstrap::core::config::config::Config>::parse_inner::<bootstrap::core::builder::tests::test_prebuilt_llvm_config_path_resolution::configure::{closure#0}>
             at ./src/core/config/config.rs:2272:17
   6: bootstrap::core::builder::tests::test_prebuilt_llvm_config_path_resolution::configure
             at ./src/core/builder/tests.rs:1067:9
   7: bootstrap::core::builder::tests::test_prebuilt_llvm_config_path_resolution
             at ./src/core/builder/tests.rs:1151:18
   8: bootstrap::core::builder::tests::test_prebuilt_llvm_config_path_resolution::{closure#0}
             at ./src/core/builder/tests.rs:1065:47
   9: <bootstrap::core::builder::tests::test_prebuilt_llvm_config_path_resolution::{closure#0} as core::ops::function::FnOnce<()>>::call_once
             at /build/rustc-1.87-u8IF76/rustc-1.87-1.87.0+dfsg0ubuntu1/library/core/src/ops/function.rs:250:5
  10: core::ops::function::FnOnce::call_once
             at /build/rustc-1.87-u8IF76/rustc-1.87-1.87.0+dfsg0ubuntu1/library/core/src/ops/function.rs:250:5
```

#### triagebot.toml doesn't exist

Tests failing for this reason:

- `check_rustc_if_unchanged_paths`

Example:

```
thread 'core::config::tests::check_rustc_if_unchanged_paths' panicked at src/bootstrap/src/core/config/tests.rs:474:9:
triagebot.toml doesn't exist.
stack backtrace:
   0: __rustc::rust_begin_unwind
             at /build/rustc-1.87-u8IF76/rustc-1.87-1.87.0+dfsg0ubuntu1/library/std/src/panicking.rs:697:5
   1: core::panicking::panic_fmt
             at /build/rustc-1.87-u8IF76/rustc-1.87-1.87.0+dfsg0ubuntu1/library/core/src/panicking.rs:75:14
   2: bootstrap::core::config::tests::check_rustc_if_unchanged_paths
             at ./src/core/config/tests.rs:474:9
   3: bootstrap::core::config::tests::check_rustc_if_unchanged_paths::{closure#0}
             at ./src/core/config/tests.rs:464:36
   4: <bootstrap::core::config::tests::check_rustc_if_unchanged_paths::{closure#0} as core::ops::function::FnOnce<()>>::call_once
             at /build/rustc-1.87-u8IF76/rustc-1.87-1.87.0+dfsg0ubuntu1/library/core/src/ops/function.rs:250:5
   5: core::ops::function::FnOnce::call_once
             at /build/rustc-1.87-u8IF76/rustc-1.87-1.87.0+dfsg0ubuntu1/library/core/src/ops/function.rs:250:5
```

#### None != Some("src/tools/cargo")

Tests failing for this reason:

- `test_submodule_path_of`

Example:

```
thread 'utils::helpers::tests::test_submodule_path_of' panicked at src/bootstrap/src/utils/helpers/tests.rs:112:5:
assertion `left == right` failed
  left: None
 right: Some("src/tools/cargo")
stack backtrace:
   0: __rustc::rust_begin_unwind
             at /build/rustc-1.87-u8IF76/rustc-1.87-1.87.0+dfsg0ubuntu1/library/std/src/panicking.rs:697:5
   1: core::panicking::panic_fmt
             at /build/rustc-1.87-u8IF76/rustc-1.87-1.87.0+dfsg0ubuntu1/library/core/src/panicking.rs:75:14
   2: core::panicking::assert_failed_inner
             at /build/rustc-1.87-u8IF76/rustc-1.87-1.87.0+dfsg0ubuntu1/library/core/src/panicking.rs:425:17
   3: core::panicking::assert_failed::<core::option::Option<alloc::string::String>, core::option::Option<alloc::string::String>>
             at /build/rustc-1.87-u8IF76/rustc-1.87-1.87.0+dfsg0ubuntu1/library/core/src/panicking.rs:380:5
   4: bootstrap::utils::helpers::tests::test_submodule_path_of
             at ./src/utils/helpers/tests.rs:112:5
   5: bootstrap::utils::helpers::tests::test_submodule_path_of::{closure#0}
             at ./src/utils/helpers/tests.rs:104:28
   6: <bootstrap::utils::helpers::tests::test_submodule_path_of::{closure#0} as core::ops::function::FnOnce<()>>::call_once
             at /build/rustc-1.87-u8IF76/rustc-1.87-1.87.0+dfsg0ubuntu1/library/core/src/ops/function.rs:250:5
   7: core::ops::function::FnOnce::call_once
             at /build/rustc-1.87-u8IF76/rustc-1.87-1.87.0+dfsg0ubuntu1/library/core/src/ops/function.rs:250:5
```

## Fix Attempt

In order to keep the tests actually accurate, we should only change the default settings when _absolutely necessary_. Here, we only set `build.optimized_compiler_builtins`, `build.tools`, `llvm.ninja`, `llvm.download_ci_llvm`, and `rust.download_rustc`.

- `build.optimized_compiler_builtins` must be set because we don't vendor LLVM. Therefore, we don't have access to the `compiler-rt` source needed to optimize the compiler builtins.
- `build.tools` must be set because the tools we _don't_ build are pruned from the source tarball, meaning that if anything _attempted_ to build these tools, even as a test, it would fail.
- `llvm.ninja` must be set because we can't use Ninja is not available in the build environment.
- `llvm.download_ci_llvm` must be set because the build environment must be isolated and cannot download anything outside of the package itself.
- `rust.download_rustc` is set for the same reason as `llvm.download_ci_llvm` — we can't download anything inside the build environment.

Unfortunately, the `Llvm` and `Rust` structs don't implement `Default` like `Build` does, so we are forced to express every empty field explicitly.

```diff
--- a/src/bootstrap/src/core/config/config.rs
+++ b/src/bootstrap/src/core/config/config.rs
@@ -1429,7 +1429,16 @@

     pub(crate) fn get_toml(file: &Path) -> Result<TomlConfig, toml::de::Error> {
         #[cfg(test)]
-        return Ok(TomlConfig::default());
+        if file.exists() {
+            // Ubuntu: Normally, tests would simply get the default toml. However, we need to
+            // cherry-pick select bootstrap configuration values from bootstrap.toml to stop
+            // certain tests from failing.
+            return Self::get_toml_inner(file);
+        } else {
+            // Some tests, not expecting to actually read a toml, give a path that doesn't exist.
+            // If they do this, then simply return the default toml.
+            return Ok(TomlConfig::default());
+        }

         #[cfg(not(test))]
         Self::get_toml_inner(file)
@@ -1629,6 +1638,129 @@
         };

         if cfg!(test) {
+            // Ubuntu: Certain configuration defaults are impossible given the way we build our
+            // packages.
+            //
+            // Even in a test environment, we read `debian/bootstrap.toml` unconditionally. (See fn
+            // get_toml). We take only the necessary fields and overlay them on top of the
+            // TomlConfig::default() normally used for tests.
+            let mut test_toml = TomlConfig::default();
+
+            if let Some(build) = toml.build {
+                test_toml.build = Some(Build {
+                    // Since we don't have a vendored LLVM, we don't have a compiler-rt source,
+                    // meaning optimizing compiler builtins is impossible.
+                    optimized_compiler_builtins: build.optimized_compiler_builtins,
+                    // We prune the sources of tools we don't build from the source tarball itself,
+                    // meaning that attempting to build any other tools, even in testing, will
+                    // always fail.
+                    tools: build.tools,
+                    ..Default::default()
+                });
+            }
+
+            if let Some(llvm) = toml.llvm {
+                // Unlike Build, the Llvm struct unfortunately does not implement Default.
+                test_toml.llvm = Some(Llvm {
+                    optimize: None,
+                    thin_lto: None,
+                    release_debuginfo: None,
+                    assertions: None,
+                    tests: None,
+                    enzyme: None,
+                    plugins: None,
+                    ccache: None,
+                    static_libstdcpp: None,
+                    libzstd: None,
+                    // We can't use Ninja to build anything, as it is not included in the build
+                    // environment.
+                    ninja: llvm.ninja,
+                    targets: None,
+                    experimental_targets: None,
+                    link_jobs: None,
+                    link_shared: None,
+                    version_suffix: None,
+                    clang_cl: None,
+                    cflags: None,
+                    cxxflags: None,
+                    ldflags: None,
+                    use_libcxx: None,
+                    use_linker: None,
+                    allow_old_toolchain: None,
+                    offload: None,
+                    polly: None,
+                    clang: None,
+                    enable_warnings: None,
+                    // We are unable to download LLVM. This can never be enabled.
+                    download_ci_llvm: llvm.download_ci_llvm,
+                    build_config: None,
+                });
+            }
+
+            if let Some(rust) = toml.rust {
+                // The Rust struct does not currently have a Default implementation, so for now, we
+                // must manually initialize all fields we want to leave at their defaults to None.
+                test_toml.rust = Some(Rust {
+                    optimize: None,
+                    debug: None,
+                    codegen_units: None,
+                    codegen_units_std: None,
+                    rustc_debug_assertions: None,
+                    randomize_layout: None,
+                    std_debug_assertions: None,
+                    tools_debug_assertions: None,
+                    overflow_checks: None,
+                    overflow_checks_std: None,
+                    debug_logging: None,
+                    debuginfo_level: None,
+                    debuginfo_level_rustc: None,
+                    debuginfo_level_std: None,
+                    debuginfo_level_tools: None,
+                    debuginfo_level_tests: None,
+                    backtrace: None,
+                    incremental: None,
+                    default_linker: None,
+                    channel: None,
+                    description: None,
+                    musl_root: None,
+                    rpath: None,
+                    strip: None,
+                    frame_pointers: None,
+                    stack_protector: None,
+                    verbose_tests: None,
+                    optimize_tests: None,
+                    codegen_tests: None,
+                    omit_git_hash: None,
+                    dist_src: None,
+                    save_toolstates: None,
+                    codegen_backends: None,
+                    llvm_bitcode_linker: None,
+                    lld: None,
+                    lld_mode: None,
+                    llvm_tools: None,
+                    deny_warnings: None,
+                    backtrace_on_ice: None,
+                    verify_llvm_ir: None,
+                    thin_lto_import_instr_limit: None,
+                    remap_debuginfo: None,
+                    jemalloc: None,
+                    test_compare_mode: None,
+                    llvm_libunwind: None,
+                    control_flow_guard: None,
+                    ehcont_guard: None,
+                    new_symbol_mangling: None,
+                    profile_generate: None,
+                    profile_use: None,
+                    // We are unable to download rustc. This can never be enabled.
+                    download_rustc: rust.download_rustc,
+                    lto: None,
+                    validate_mir_opts: None,
+                    std_features: None
+                });
+            }
+
+            toml = test_toml;
+
             // When configuring bootstrap for tests, make sure to set the rustc and Cargo to the
             // same ones used to call the tests (if custom ones are not defined in the toml). If we
             // don't do that, bootstrap will use its own detection logic to find a suitable rustc
```

## Fix Attempt Results

The following 28 tests fail without any changes:

- `core::builder::tests::alias_and_path_for_library`
- `core::builder::tests::defaults::build_default`
- `core::builder::tests::defaults::build_stage_0`
- `core::builder::tests::defaults::doc_default`
- `core::builder::tests::dist::dist_all_cross`
- `core::builder::tests::dist::test_docs`
- `core::builder::tests::test_exclude_kind`
- `core::builder::tests::test_prebuilt_llvm_config_path_resolution`
- `core::builder::tests::test_test_coverage`
- `core::config::tests::check_rustc_if_unchanged_paths`
- `core::config::tests::test_ci_flag`
- `core::config::tests::test_cyclic_include_direct`
- `core::config::tests::test_cyclic_include_indirect`
- `core::config::tests::test_include_precedence_over_profile`
- `core::config::tests::test_precedence_of_includes`
- `utils::build_stamp::tests::test_is_up_to_date`
- `utils::build_stamp::tests::test_with_invalid_prefix`
- `utils::build_stamp::tests::test_with_invalid_prefix2`
- `utils::build_stamp::tests::test_with_prefix`
- `utils::cc_detect::tests::test_default_compiler_fallback`
- `utils::cc_detect::tests::test_default_compiler_wasi`
- `utils::cc_detect::tests::test_find`
- `utils::cc_detect::tests::test_find_target_with_config`
- `utils::cc_detect::tests::test_find_target_without_config`
- `utils::cc_detect::tests::test_new_cc_build`
- `utils::helpers::tests::test_set_file_times_sanity_check`
- `utils::helpers::tests::test_submodule_path_of`
- `utils::helpers::tests::test_symlink_dir`

The following 16 tests fail after applying the above patch:

- `core::builder::tests::alias_and_path_for_library`
- `core::builder::tests::defaults::build_default`
- `core::builder::tests::defaults::build_stage_0`
- `core::builder::tests::defaults::doc_default`
- `core::builder::tests::dist::dist_all_cross`
- `core::builder::tests::dist::test_docs`
- `core::builder::tests::test_exclude_kind`
- `core::builder::tests::test_prebuilt_llvm_config_path_resolution`
- `core::builder::tests::test_test_coverage`
- `core::config::tests::check_rustc_if_unchanged_paths`
- `core::config::tests::test_ci_flag`
- `core::config::tests::test_cyclic_include_direct`
- `core::config::tests::test_cyclic_include_indirect`
- `core::config::tests::test_include_precedence_over_profile`
- `core::config::tests::test_precedence_of_includes`
- `utils::helpers::tests::test_submodule_path_of`

All of these tests were already failing before the patch, so cherry-picking specific fields from `bootstrap.toml` has not caused any regressions.

## Fix Attempt Bugfix

There's a logic error in my patch — in the test configuration, it unconditionally cherry-picks certain fields _after_ running `get_toml`. The unpatched `get_toml` in `config.rs` always returns `TomlConfig::default` in the `test` configuration, but functions calling `Config::parse_inner` directly don't _have_ to use that `get_toml`!

This means that certain tests' config values weren't being properly passed to the config, because my patch assumed `TomlConfig::default` would always be the baseline.

Additionally, further testing shows that setting `toml.build.tools` and values in `toml.llvm` and `toml.rust` is unnecessary. The exact same tests pass and fail with those overwrites disabled _or_ enabled.

By moving the cherry-picking logic into the `get_toml` in `config.rs`, we can ensure that we're _only_ modifying what would otherwise be `TomlConfig::default`:

```diff
--- a/src/bootstrap/src/core/config/config.rs
+++ b/src/bootstrap/src/core/config/config.rs
@@ -1429,7 +1429,34 @@

     pub(crate) fn get_toml(file: &Path) -> Result<TomlConfig, toml::de::Error> {
         #[cfg(test)]
-        return Ok(TomlConfig::default());
+        if file.exists() {
+            // Ubuntu: Normally, tests would simply get the default toml. However, some of the
+            // default values are impossible given our toolchain configuration. Therefore, we must
+            // cherry-pick select bootstrap configuration options from bootstrap.toml to prevent
+            // certain tests from failing.
+            return Self::get_toml_inner(file)
+                .map(|toml| {
+                    // We start with the default config that would be normally returned in a test
+                    // config, then cherry-pick only certain values from the actual bootstrap.toml,
+                    // keeping things as similar to the original test configuration as possible.
+                    let mut test_toml = TomlConfig::default();
+
+                    if let Some(build) = toml.build {
+                        test_toml.build = Some(Build {
+                            // Since we don't have a vendored LLVM, we don't have a compiler-rt source,
+                            // meaning optimizing compiler builtins is impossible.
+                            optimized_compiler_builtins: build,
+                            ..Default::default()
+                        });
+                    }
+
+                    test_toml
+                });
+        } else {
+            // Some tests, not expecting to actually read a toml, give a path that doesn't exist.
+            // If they do this, then simply return the default toml.
+            return Ok(TomlConfig::default());
+        }

         #[cfg(not(test))]
         Self::get_toml_inner(file)
```

The following 7 tests fail after applying the above patch:

- `core::builder::tests::dist::dist_all_cross`
- `core::builder::tests::test_exclude_kind`
- `core::builder::tests::test_prebuilt_llvm_config_path_resolution`
- `core::builder::tests::test_test_coverage`
- `core::config::tests::check_rustc_if_unchanged_paths`
- `core::config::tests::test_ci_flag`
- `utils::helpers::tests::test_submodule_path_of`

## Why Didn't They Fail Previously?

To check for versioned regressions, I investigated the successful 1.87 buildlogs and source. Suspiciously, even though all failing tests existed in the source code, none of them showed up in the buildlog.

I rebuilt 1.87 locally and entered the schroot after testing completed. I then tried to run a failing test on its own:

```
debian/rules override_dh_auto_test-arch RUSTBUILD_TEST_FLAGS="src/bootstrap/ --test-args alias_and_path_for_library"
```

Sure enough, the test failed, but for an unexpected reason:

```
error[E0425]: cannot find function `detail_exit` in the crate root
    --> src/bootstrap/src/core/config/config.rs:1387:28
     |
1387 |                     crate::detail_exit(2);
     |                            ^^^^^^^^^^^ not found in the crate root
     |
help: consider importing this function
     |
6    + use build_helper::util::detail_exit;
     |
help: if you import `detail_exit`, refer to it directly
     |
1387 -                     crate::detail_exit(2);
1387 +                     detail_exit(2);
     |

error[E0308]: mismatched types
    --> src/bootstrap/src/core/config/config.rs:1385:39
     |
1385 |   ...   .unwrap_or_else(|err| {
     |  _____________________________^
1386 | | ...       eprintln!("failed to parse TOML configuration '{}': {err}", file.display());
1387 | | ...       crate::detail_exit(2);
1388 | | ...   })
     | |_______^ expected `TomlConfig`, found `()`

error[E0308]: mismatched types
    --> src/bootstrap/src/core/config/config.rs:1374:13
     |
1363 |       pub(crate) fn get_toml(file: &Path) -> Result<TomlConfig, toml::de::Error> {
     |                                              ----------------------------------- expected `Result<core::config::config::TomlConfig, toml::de::Error>` because of return type
...
1374 | /             toml::from_str(&contents)
1375 | |                 .and_then(|table: toml::Value| TomlConfig::deserialize(table))
1376 | |                 .map(|table| {
1377 | |                     let mut config = TomlConfig::default();
...    |
1387 | |                     crate::detail_exit(2);
1388 | |                 })
     | |__________________^ expected `Result<TomlConfig, Error>`, found `TomlConfig`
     |
     = note: expected enum `Result<core::config::config::TomlConfig, toml::de::Error>`
              found struct `core::config::config::TomlConfig`
help: try wrapping the expression in `Ok`
     |
1374 ~             Ok(toml::from_str(&contents)
1375 |                 .and_then(|table: toml::Value| TomlConfig::deserialize(table))
 ...
1387 |                     crate::detail_exit(2);
1388 ~                 }))
     |
```

It turns out that since at least 1.79 (and likely even earlier), a compile-time error in the bootstrap test configuration has prevented bootstrap unit tests from running at all! The new test failures we're seeing aren't caused by anything in 1.88 — they were actually just being run for the first time in ages.

## Comparison With Debian

While it isn't a perfect comparison, we can at least see which bootstrap tests have been failing on Debian too.

These 4 failing tests exist in Debian 1.86, and they fail there as well:

- core::builder::tests::test_exclude_kind
- core::builder::tests::test_test_coverage
- core::config::tests::check_rustc_if_unchanged_paths
- utils::helpers::tests::test_submodule_path_of

These 2 failing tests don't exist on Debian 1.86:

- core::builder::tests::dist::dist_all_cross
- core::config::tests::test_ci_flag

The following failing test succeeds in Debian:

- core::builder::tests::test_prebuilt_llvm_config_path_resolution

## Which Tests can't we Disable?

#### `test_exclude_kind`

This test ensures that tests and builds for the Rust compiler and standard library aren't skipped even when certain paths are excluded. We likely want this test — if `bootstrap test` doesn't run certain tests, then the package build process will silently skip them, resulting in an erroenously-successful build.

It fails because "x.py completions were changed".

#### `test_test_coverage`

This test ensures that passing strings to `bootstrap test` filters for the right things. We likely want this test — if `bootstrap test` filters aren't working properly, then we risk silently skipping other tests during the build process.

Just like `test_exclude_kind`, it fails because "x.py completions were changed."

#### `check_rustc_if_unchanged_paths`

This test ensures the allowed paths for `download-rustc = "if-unchanged"` exist and are of the proper format.

We don't care about this test because we can't download rustc. It can be disabled.

#### `test_submodule_path_of`

This test ensures the path to the containing Git submodule is returned correctly.

This test is irrelevant to us, as we are not using a Git-managed source.

#### `dist_all_cross`

This test ensures that the right things are built when cross-compiling, but it fails because we don't have Ninja.

#### `test_ci_flag`

This test simply checks to see if `config.is_running_on_ci` is set properly. It needs an upstream Git repo to function. We can disable this test.

#### `test_prebuilt_llvm_config_path_resolution`

This test ensures that the prebuilt LLVM config path gets parsed properly from the config toml. This functionality _is indeed_ important for our purposes.

The build failure is caused by the very end of the test. It tries to parse a config with `download-ci-llvm = "if-unchanged"`, which is impossible for our toolchain.

While this functionality is important, we'll know if `bootstrap` can't resolve our prebuilt LLVM path because the build will fail! We can disable this test.

## The Solution

I applied version 2 of my patch (i.e. the one that just disables `build.optimized_compiler_builtins`). I also disabled `test_prebuilt_llvm_config_path_resolution`, `check_rustc_if_unchanged_paths`, `test_ci_flag`, and `test_submodule_path_of` because all four tests required a Git-managed source.
