## The Problem

On `ppc64el`, the following tests which passed for `rustc-1.85` are now failing for `rustc-1.86`:

```
test [debuginfo-gdb] tests/debuginfo/basic-types-globals-metadata.rs ... FAILED
test [debuginfo-gdb] tests/debuginfo/basic-types-globals.rs#no-lto ... FAILED
test [debuginfo-gdb] tests/debuginfo/basic-types-globals.rs#lto ... FAILED
...
test library/std/src/f16.rs - f16::f16::erfc (line 1321) ... FAILED
```

All of those tests fail with the message `undefined reference to __gnu_h2f_ieee`:

```
---- [debuginfo-gdb] tests/debuginfo/basic-types-globals-metadata.rs stdout ----


executing env -u \
    RUSTC_LOG_COLOR RUSTC_ICE="0" \
    RUST_BACKTRACE="short" \
    "/<<PKGBUILDDIR>>/build/powerpc64le-unknown-linux-gnu/stage2/bin/rustc" \
    "/<<PKGBUILDDIR>>/tests/debuginfo/basic-types-globals-metadata.rs" \
    "-Zthreads=1" \
    "-Zsimulate-remapped-rust-src-base=/rustc/FAKE_PREFIX" \
    "-Ztranslate-remapped-path-to-local-path=no" \
    "-Z" "ignore-directory-in-diagnostics-source-blocks=/<<PKGBUILDDIR>>/debian/cargo" \
    "-Z" "ignore-directory-in-diagnostics-source-blocks=/<<PKGBUILDDIR>>/vendor" \
    "--sysroot" "/<<PKGBUILDDIR>>/build/powerpc64le-unknown-linux-gnu/stage2" \
    "--target=powerpc64le-unknown-linux-gnu" \
    "--check-cfg" "cfg(test,FALSE)" \
    "-C" "prefer-dynamic" \
    "-o" "/<<PKGBUILDDIR>>/build/powerpc64le-unknown-linux-gnu/test/debuginfo/basic-types-globals-metadata.gdb/a" \
    "-A" "internal_features" \
    "-Crpath" \
    "-Lnative=/<<PKGBUILDDIR>>/build/powerpc64le-unknown-linux-gnu/native/rust-test-helpers" \
    "-Clinker=powerpc64le-linux-gnu-gcc" \
    "-g"
------rustc stdout------------------------------

------rustc stderr------------------------------
error: linking with `powerpc64le-linux-gnu-gcc` failed: exit status: 1
  |
  = note:  "powerpc64le-linux-gnu-gcc" \
    "-m64" "/tmp/rustc1cwK0W/symbols.o" \
    "<1 object files omitted>" \
    "-Wl,--as-needed" \
    "-Wl,-Bdynamic" \
    "<sysroot>/lib/rustlib/powerpc64le-unknown-linux-gnu/lib/libstd-f330a7792c19d646.so" \
    "-Wl,-Bstatic" \
    "<sysroot>/lib/rustlib/powerpc64le-unknown-linux-gnu/lib/{libcompiler_builtins-*}.rlib" \
    "-Wl,-Bdynamic" \
    "-lgcc_s" \
    "-lutil" \
    "-lrt" \
    "-lpthread" \
    "-lm" \
    "-ldl" \
    "-lc" \
    "-Wl,--eh-frame-hdr" \
    "-Wl,-z,noexecstack" \
    "-L" "/<<PKGBUILDDIR>>/build/powerpc64le-unknown-linux-gnu/native/rust-test-helpers" \
    "-L" "<sysroot>/lib/rustlib/powerpc64le-unknown-linux-gnu/lib" \
    "-o" "/<<PKGBUILDDIR>>/build/powerpc64le-unknown-linux-gnu/test/debuginfo/basic-types-globals-metadata.gdb/a" \
    "-Wl,--gc-sections" \
    "-pie" \
    "-Wl,-z,relro,-z,now" \
    "-nodefaultlibs" \
    "-Wl,-rpath,$ORIGIN/../../../stage2/lib/rustlib/powerpc64le-unknown-linux-gnu/lib,--enable-new-dtags,-z,origin"
  = note: some arguments are omitted. use `--verbose` to show all linker arguments
  = note: /usr/bin/ld: /<<PKGBUILDDIR>>/build/powerpc64le-unknown-linux-gnu/test/debuginfo/basic-types-globals-metadata.gdb/a.basic_types_globals_metadata.fd3226a68c1b1964-cgu.0.rcgu.o: in function `basic_types_globals_metadata::main':
          /<<PKGBUILDDIR>>/tests/debuginfo/basic-types-globals-metadata.rs:62:(.text._ZN28basic_types_globals_metadata4main17h180c8ddb6321e220E+0x2bc): undefined reference to `__gnu_h2f_ieee'
          /usr/bin/ld: /<<PKGBUILDDIR>>/tests/debuginfo/basic-types-globals-metadata.rs:62:(.text._ZN28basic_types_globals_metadata4main17h180c8ddb6321e220E+0x3b4): undefined reference to `__gnu_f2h_ieee'
          collect2: error: ld returned 1 exit status

  = note: some `extern` functions couldn't be found; some native libraries may need to be installed or have their path specified
  = note: use the `-l` flag to specify native libraries to link

error: aborting due to 1 previous error
```

## Debian status

I checked the [Debian build logs](https://buildd.debian.org/status/package.php?p=rustc&suite=experimental) and it looks like they're in the exact same spot- it's building everywhere except on `ppc64el` for the exact same reason.

## Finding the Source

#### LLVM

Since `rustc-1.86` and `rustc-1.85` both use the same system LLVM to build, we know that the problem isn't related to LLVM.

#### `f16_enabled` cfg in `compiler_builtins`

Checking the `ppc64el` build logs for both 1.85 and 1.86, `f16_enabled` is (correctly) not enabled at any point for either, so we know that `f16_enabled` is not being set erroneously.

#### Confirm `compiler_builtins` symbol generation is consistent between versions

In order to be 100% sure `compiler_builtins` isn't including `__gnu_h2f_ieee`, I patched `d/rules` to print all `compiler_builtins` symbols after the build:

```diff
@@ -321,6 +321,19 @@ clean_generated:

 debian/dh_auto_build.stamp:
        $(RUSTBUILD) build $(RUSTBUILD_FLAGS)
+       # Extract and print all symbols from compiler_builtins
+       @echo "Dumping all symbols from compiler_builtins rlibs..."
+       @find build/ -name "libcompiler_builtins-*.rlib" | while read -r rlib; do \
+         echo "Inspecting $$rlib..."; \
+         mkdir -p tmp_ar_extract; \
+         cd tmp_ar_extract && ar x "$$rlib" && \
+           for obj in *.o; do \
+             echo "=== $$obj ==="; \
+             nm "$$obj" | sort; \
+           done; \
+         cd ..; \
+         rm -rf tmp_ar_extract; \
+       done

 override_dh_auto_build-arch: debian/dh_auto_build.stamp
 ifeq (true,$(BUILD_WINDOWS))
```

I then built both `rustc-1.85` and `rustc-1.86` in a `ppc64el` PPA with this patch.

Here's the diff between the generated `compiler_builtins` symbols for 1.85 and 1.86:

```diff
@@ -13,31 +13,6 @@ __addsf3
 __addsf3
 __addsf3
 __addsf3
-anon.0fe1201ee77b5e5e631def0c27b1085d.0.llvm.5525817915183521172
-anon.0fe1201ee77b5e5e631def0c27b1085d.0.llvm.5525817915183521172
-anon.0fe1201ee77b5e5e631def0c27b1085d.0.llvm.5525817915183521172
-anon.0fe1201ee77b5e5e631def0c27b1085d.1.llvm.5525817915183521172
-anon.0fe1201ee77b5e5e631def0c27b1085d.1.llvm.5525817915183521172
-anon.0fe1201ee77b5e5e631def0c27b1085d.1.llvm.5525817915183521172
-anon.0fe1201ee77b5e5e631def0c27b1085d.2.llvm.5525817915183521172
-anon.0fe1201ee77b5e5e631def0c27b1085d.2.llvm.5525817915183521172
-anon.0fe1201ee77b5e5e631def0c27b1085d.2.llvm.5525817915183521172
-anon.0fe1201ee77b5e5e631def0c27b1085d.3.llvm.5525817915183521172
-anon.0fe1201ee77b5e5e631def0c27b1085d.3.llvm.5525817915183521172
-anon.0fe1201ee77b5e5e631def0c27b1085d.3.llvm.5525817915183521172
-anon.0fe1201ee77b5e5e631def0c27b1085d.4.llvm.5525817915183521172
-anon.0fe1201ee77b5e5e631def0c27b1085d.4.llvm.5525817915183521172
-anon.0fe1201ee77b5e5e631def0c27b1085d.4.llvm.5525817915183521172
-anon.5cbafa4f0e3a353e2536cc4d5c631c89.0.llvm.1679039154672575102
-anon.5cbafa4f0e3a353e2536cc4d5c631c89.0.llvm.1679039154672575102
-anon.5cbafa4f0e3a353e2536cc4d5c631c89.1.llvm.1679039154672575102
-anon.5cbafa4f0e3a353e2536cc4d5c631c89.1.llvm.1679039154672575102
-anon.5cbafa4f0e3a353e2536cc4d5c631c89.2.llvm.1679039154672575102
-anon.5cbafa4f0e3a353e2536cc4d5c631c89.2.llvm.1679039154672575102
-anon.5cbafa4f0e3a353e2536cc4d5c631c89.3.llvm.1679039154672575102
-anon.5cbafa4f0e3a353e2536cc4d5c631c89.3.llvm.1679039154672575102
-anon.5cbafa4f0e3a353e2536cc4d5c631c89.4.llvm.1679039154672575102
-anon.5cbafa4f0e3a353e2536cc4d5c631c89.4.llvm.1679039154672575102
 __ashldi3
 __ashldi3
 __ashldi3
@@ -988,11 +963,6 @@ compiler_builtins::mem::strlen
 compiler_builtins::mem::strlen
 compiler_builtins::mem::strlen
 compiler_builtins::mem::strlen
-core::slice::<impl [T]>::copy_from_slice
-core::slice::<impl [T]>::copy_from_slice
-core::slice::<impl [T]>::copy_from_slice
-core::slice::<impl [T]>::copy_from_slice
-core::slice::<impl [T]>::copy_from_slice
 __ctzdi2
 __ctzdi2
 __ctzdi2
```

`__gnu_h2f_ieee` is not in either, so we know that `compiler_builtins` isn't supposed to be generating the symbol. The issue is because the offending tests are expecting this helper from another source.

#### Missing symbols, or bad symbol generation?

This narrows us down to two theories:

1. The tests have always needed `__gnu_h2f_ieee`. Something changed in 1.86 which prevents the tests from finding the symbols they need.
2. The tests shouldn't be looking for `__gnu_h2f_ieee`, but something changed in 1.86 which makes the tests erroneously require that symbol.

To figure out which of the two theories is true, we patch the failing tests so they generate their intermediate compilation steps:

```diff
--- a/tests/debuginfo/basic-types-globals-metadata.rs
+++ b/tests/debuginfo/basic-types-globals-metadata.rs
@@ -1,4 +1,4 @@
-//@ compile-flags:-g
+//@ compile-flags:-g -Csave-temps --emit=llvm-ir,link

 // gdb-command:run
 // gdb-command:whatis basic_types_globals_metadata::B
--- a/tests/debuginfo/basic-types-globals.rs
+++ b/tests/debuginfo/basic-types-globals.rs
@@ -1,6 +1,6 @@
 //@ revisions: lto no-lto

-//@ compile-flags:-g
+//@ compile-flags:-g -Csave-temps --emit=llvm-ir,link

 //@ [lto] compile-flags:-C lto
 //@ [lto] no-prefer-dynamic
```

Then, we edit `d/rules` to print out the generated files after testing:

```diff
@@ -382,6 +382,23 @@ endif
        { $(RUSTBUILD_TEST) $(RUSTBUILD_FLAGS) $(RUSTBUILD_TEST_FLAGS); echo $$?; } | tee -a $(TEST_LOG)
        # test that the log has at least 1 pass, to prevent e.g. #57709
        grep -l "^test .* \.\.\. ok$$" $(TEST_LOG)
+
+       @echo "Inspecting f16-related test build artifacts..."
+       @for pattern in \
+               basic-types-globals-metadata \
+               basic-types-globals \
+               f16; do \
+               echo ">>> Files for pattern: $$pattern"; \
+               find build/ -type f \( -name "*$$pattern*.ll" -o -name "*$$pattern*.o" \) | while read -r f; do \
+                       echo "=== $$f ==="; \
+                       if echo "$$f" | grep -q '\.ll$$'; then \
+                               cat "$$f"; \
+                       elif echo "$$f" | grep -q '\.o$$'; then \
+                               nm -C --defined-only "$$f" || true; \
+                       fi; \
+               done; \
+       done
+
        echo "==== Debian rustc test report ===="; \
        echo "Specific test failures:"; \
        $(FAILED_TESTS); \
```
